# Use official Java 17 (Temurin) LTS base image with Ubuntu Jammy
FROM eclipse-temurin:17-jammy

# Install required CLI tools
RUN apt-get update && \
    apt-get install -y curl zip unzip && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Set WireMock version
ENV WIREMOCK_VERSION=2.33.2

# Download the standalone WireMock JAR
RUN curl -L "https://repo1.maven.org/maven2/com/github/tomakehurst/wiremock-jre8-standalone/${WIREMOCK_VERSION}/wiremock-jre8-standalone-${WIREMOCK_VERSION}.jar" \
    -o /wiremock.jar

# Optional: expose stub folders for mappings & __files
VOLUME ["/home/wiremock/mappings", "/home/wiremock/__files"]

# Expose WireMock's default HTTP port
EXPOSE 8080

# Entrypoint for WireMock
ENTRYPOINT ["java", "-jar", "/wiremock.jar"]
CMD ["--verbose", "--global-response-templating"]


# Replace blocked Ubuntu security/archive URLs with open mirrors
RUN sed -i 's|http://security.ubuntu.com/ubuntu|http://mirror.ubuntu.com/ubuntu|g' /etc/apt/sources.list && \
    sed -i 's|http://archive.ubuntu.com/ubuntu|http://mirror.ubuntu.com/ubuntu|g' /etc/apt/sources.list


# ðŸ›  Patch blocked Ubuntu URLs
RUN sed -i 's|security.ubuntu.com|mirror.ubuntu.com|g' /etc/apt/sources.list && \
    sed -i 's|archive.ubuntu.com|mirror.ubuntu.com|g' /etc/apt/sources.list

FROM debian:bullseye-slim

docker run --rm ubuntu:jammy bash -c "apt-get update && apt-get install -y dnsutils && nslookup archive.ubuntu.com"


docker run --rm ubuntu:jammy bash -c "apt-get update"

sudo mkdir -p /etc/systemd/system/docker.service.d

sudo tee /etc/systemd/system/docker.service.d/http-proxy.conf <<EOF
[Service]
Environment="HTTP_PROXY=http://your.proxy.com:8080/"
Environment="HTTPS_PROXY=http://your.proxy.com:8080/"
Environment="NO_PROXY=localhost,127.0.0.1"
EOF

sudo systemctl daemon-reexec
sudo systemctl daemon-reload
sudo systemctl restart docker

RUN apt-get update && \
    apt-get install -y curl zip unzip openjdk-17-jre-headless && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

ENV WIREMOCK_VERSION=2.33.2
RUN curl -L "https://repo1.maven.org/maven2/com/github/tomakehurst/wiremock-jre8-standalone/${WIREMOCK_VERSION}/wiremock-jre8-standalone-${WIREMOCK_VERSION}.jar" \
    -o /wiremock.jar

EXPOSE 8080
ENTRYPOINT ["java", "-jar", "/wiremock.jar"]
CMD ["--global-response-templating", "--no-request-journal", "--disable-banner"]

sudo mkdir -p /etc/systemd/system/docker.service.d

sudo tee /etc/systemd/system/docker.service.d/http-proxy.conf <<EOF
[Service]
Environment="HTTP_PROXY=http://your.proxy.com:8080/"
Environment="HTTPS_PROXY=http://your.proxy.com:8080/"
Environment="NO_PROXY=localhost,127.0.0.1"
EOF

sudo systemctl daemon-reexec
sudo systemctl daemon-reload
sudo systemctl restart docker
docker run --rm --network=host ubuntu:jammy bash -c "apt-get update"

docker run --rm --dns=8.8.8.8 ubuntu:jammy bash -c "apt-get update"
docker run --rm ubuntu:jammy bash -c "apt-get update"

docker run --rm ubuntu:jammy bash -c "apt-get update && apt-get install -y dnsutils && nslookup archive.ubuntu.com"
docker run --rm ubuntu:jammy bash -c "apt-get update && apt-get install -y curl && curl -I http://archive.ubuntu.com"

# docker_auth.py

import os
import subprocess

def docker_login(username: str, token: str, registry: str, config_path: str = "/tmp/my-docker-config"):
    os.environ["DOCKER_CONFIG"] = config_path
    os.makedirs(config_path, exist_ok=True)

    login_cmd = f"echo '{token}' | docker login {registry} --username {username} --password-stdin"
    subprocess.run(login_cmd, shell=True, check=True)
    print("âœ… Docker login successful")

from docker_auth import docker_login

# Use the helper
docker_login(
    username="naveen",
    token="your_api_token",
    registry="artifactory.mycompany.com"
)

# Continue with the rest of your logic
print("â–¶ Now doing docker build / push / other tasks...")
